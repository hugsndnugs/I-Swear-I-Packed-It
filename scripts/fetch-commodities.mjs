#!/usr/bin/env node
/**
 * Fetches Star Citizen commodities from API/wiki or uses local data.
 * - Attempts to fetch from Star Citizen API/wiki if available
 * - Falls back to local data/commodities.json if API unavailable
 * - Writes src/data/commodities.generated.ts
 *
 * Run: node scripts/fetch-commodities.mjs
 * Env:  PREFLIGHT_API_CACHE_MAX_AGE_MS=86400000 (use cache if newer than this, 0 = always fetch)
 *       PREFLIGHT_API_SKIP_CACHE=1     (ignore cache, always fetch)
 */
import { writeFileSync, readFileSync, mkdirSync, existsSync } from 'fs'
import { fileURLToPath } from 'url'
import { dirname, join } from 'path'

const __dirname = dirname(fileURLToPath(import.meta.url))
const ROOT = join(__dirname, '..')
const CACHE_DIR = join(__dirname, '.api-cache')
const CACHE_FILE = join(CACHE_DIR, 'commodities.json')
const LOCAL_JSON = join(ROOT, 'data', 'commodities.json')
const OUT_PATH = join(ROOT, 'src', 'data', 'commodities.generated.ts')

const CACHE_MAX_AGE_MS = Number(process.env.PREFLIGHT_API_CACHE_MAX_AGE_MS) ?? 86400000 // 24h
const SKIP_CACHE = process.env.PREFLIGHT_API_SKIP_CACHE === '1' || process.env.PREFLIGHT_API_SKIP_CACHE === 'true'

function sleep(ms) {
  return new Promise((r) => setTimeout(r, ms))
}

function loadLocal() {
  if (!existsSync(LOCAL_JSON)) return []
  try {
    const raw = readFileSync(LOCAL_JSON, 'utf8')
    const parsed = JSON.parse(raw)
    if (!Array.isArray(parsed)) return []
    return parsed.filter(
      (c) => c && typeof c === 'object' && typeof c.id === 'string' && typeof c.label === 'string'
    )
  } catch {
    return []
  }
}

function loadCache() {
  if (SKIP_CACHE || !existsSync(CACHE_FILE)) return null
  try {
    const raw = readFileSync(CACHE_FILE, 'utf8')
    const obj = JSON.parse(raw)
    if (!Array.isArray(obj.data)) return null
    const age = obj.fetchedAt ? Date.now() - obj.fetchedAt : Infinity
    if (CACHE_MAX_AGE_MS > 0 && age > CACHE_MAX_AGE_MS) return null
    return obj.data
  } catch {
    return null
  }
}

function saveCache(data) {
  try {
    if (!existsSync(CACHE_DIR)) mkdirSync(CACHE_DIR, { recursive: true })
    const payload = { fetchedAt: Date.now(), data }
    writeFileSync(CACHE_FILE, JSON.stringify(payload, null, 2), 'utf8')
  } catch (err) {
    console.warn('Could not write cache:', err.message)
  }
}

async function fetchCommodities() {
  // Try to fetch from Star Citizen API/wiki
  // For now, use local data as API endpoints for commodities are not well-documented
  // This can be extended when a reliable commodities API is available
  console.log('Fetching commodities...')
  
  // Check cache first
  const cached = loadCache()
  if (cached) {
    console.log(`Using cached commodities (${cached.length} items)`)
    return cached
  }

  // Try local JSON file
  const local = loadLocal()
  if (local.length > 0) {
    console.log(`Using local commodities (${local.length} items)`)
    saveCache(local)
    return local
  }

  // Fallback: return empty array (will use existing commodities.ts)
  console.warn('No commodities data found, using existing commodities.ts')
  return []
}

function generateCommoditiesFile(commodities) {
  const lines = [
    '/**',
    ' * Generated commodities list.',
    ' * Auto-generated by scripts/fetch-commodities.mjs',
    ' * Do not edit manually.',
    ' */',
    '',
    "import type { CommodityType, CommodityCategory } from './commodities'",
    '',
    'export const COMMODITIES_GENERATED: CommodityType[] = ['
  ]

  for (const c of commodities) {
    const category = c.category || 'general'
    const scuPerUnit = c.scuPerUnit !== undefined ? c.scuPerUnit : 1
    lines.push(
      `  { id: ${JSON.stringify(c.id)}, label: ${JSON.stringify(c.label)}, category: ${JSON.stringify(category)}${scuPerUnit !== 1 ? `, scuPerUnit: ${scuPerUnit}` : ''} },`
    )
  }

  lines.push(']')
  lines.push('')

  return lines.join('\n')
}

async function main() {
  try {
    const commodities = await fetchCommodities()
    
    if (commodities.length === 0) {
      console.log('No commodities to generate, skipping file write')
      return
    }

    const content = generateCommoditiesFile(commodities)
    writeFileSync(OUT_PATH, content, 'utf8')
    console.log(`âœ“ Wrote ${commodities.length} commodities to ${OUT_PATH}`)
  } catch (err) {
    console.error('Error fetching commodities:', err)
    process.exit(1)
  }
}

main()
